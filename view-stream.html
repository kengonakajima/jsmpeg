<!DOCTYPE html>
<html>
<head>
	<title>Oneframe</title>
	<style type="text/css">
		html, body {
			background-color: #111;
			text-align: center;
		}
	</style>
	
</head>
<body>  
  <h1>Oneframe</h1>
  <canvas id="video-canvas"></canvas>
  <BR>
  <table align="center">
    <tr><td>
  <button id="btn_w" onmouseup="btnUp('w')" onmousedown="btnDown('w')">W</button>
<BR>
  <button id="btn_a" onmouseup="btnUp('a')" onmousedown="btnDown('a')">A</button>
  <button id="btn_s" onmouseup="btnUp('s')" onmousedown="btnDown('s')">S</button>
  <button id="btn_d" onmouseup="btnUp('d')" onmousedown="btnDown('d')">D</button>
      </td>
      <td width=30></td>
      <td>
        <button id="btn_up" onmouseup="btnUp('Up')" onmousedown="btnDown('Up')">Up</button>
        <BR>
        <button id="btn_left" onmouseup="btnUp('Left')" onmousedown="btnDown('Left')">Left</button>
        <button id="btn_down" onmouseup="btnUp('Down')" onmousedown="btnDown('Down')">Down</button>
        <button id="btn_right" onmouseup="btnUp('Right')" onmousedown="btnDown('Right')">Right</button>


      </td>
      <td width=50></td>
      <td>
        <span id="status" style="color:#fff; font-size:20px;">status</span>
        <br>
      </td>
      
    </tr>
  </table>

  <canvas id="minivideo-canvas-0"></canvas>
  <canvas id="minivideo-canvas-1"></canvas>
  <canvas id="minivideo-canvas-2"></canvas>
  <canvas id="minivideo-canvas-3"></canvas><BR>
  <canvas id="minivideo-canvas-4"></canvas>
  <canvas id="minivideo-canvas-5"></canvas>
  <canvas id="minivideo-canvas-6"></canvas>
  <canvas id="minivideo-canvas-7"></canvas>
  
  
  <script type="text/javascript" src="hoge.js"></script>
	<script type="text/javascript" src="audioplayer.js"></script>  
	<script type="text/javascript">
      //      var isMobileSafari = navigator.userAgent.match(/(iPod|iPhone|iPad)/) && navigator.userAgent.match(/AppleWebKit/);
      var isMobileSafari=false;
      
      var g_last_main_video_decode_at = 0;
      var maincanvas = document.getElementById('video-canvas');
	  var mainurl = 'ws://'+document.location.hostname+':8082/';
	  var mainplayer = new JSMpeg.Player(mainurl, {canvas: maincanvas, disableGl: isMobileSafari, onVideoDecode: function(hoge,elt) { g_last_main_video_decode_at = Date.now(); } });
      console.log("mpegplayer:",mainplayer);
      startAudioPlayer("ws://"+document.location.hostname+':8084/');

      var testurl = "http://"+document.location.hostname+":8000/testsrc.ts";
      var testplayer = new JSMpeg.Player(testurl, {canvas: maincanvas, disableGl: isMobileSafari, onVideoDecode: function(hoge,elt) { testplayer.play(); } });

      var main_status_ws = createStatusCheckWS("ws://"+document.location.hostname+':8088/');

      // mini
      var minicanvas=[];
      var miniplayer=[];
      var minitestplayer=[];
      var ministatuscheckws=[];
      for(var i=0;i<8;i++) {
          minicanvas[i] = document.getElementById('minivideo-canvas-'+i);      
	      var miniurl = 'ws://'+document.location.hostname+':8086/';
	      miniplayer[i] = new JSMpeg.Player(miniurl, {canvas: minicanvas[i], disableGl: isMobileSafari});
          var minitesturl = "http://"+document.location.hostname+':8000/minitestsrc.ts';
          //          var minitestplayer = new JSMpeg.Player(minitesturl, {canvas: minicanvas, disableGl: isMobileSafari, onVideoDecode: function(hoge,elt) { minitestplayer.play(); } });
          minitestplayer[i] = new JSMpeg.Player(minitesturl, {canvas: minicanvas[i], disableGl: isMobileSafari, autoplay:true });
          var statusurl = 'ws://'+document.location.hostname+':8088/';
          ministatuscheckws[i] = createStatusCheckWS(statusurl);
          
      }
      
      setInterval( function() {
          var elt=main_status_ws.getElapsedTimeAfterLastVideo();
          if(elt < 400) {
              testplayer.pause();
              mainplayer.play();
          } else {
              testplayer.play();
              mainplayer.pause();              
          }
          for(var i=0;i<8;i++) {
              var elt = ministatuscheckws[i].getElapsedTimeAfterLastVideo();
              if(elt<400) {
                  minitestplayer[i].pause();
                  miniplayer[i].play();
              } else {
                  minitestplayer[i].play();
                  miniplayer[i].pause();                  
              }
          }
      },250);
      
      document.addEventListener( "keydown", function(e) {
          notifyEventAudioPlayer(e);         
      });
      document.addEventListener( "keyup", function(e) {
          notifyEventAudioPlayer(e);         
      });
      maincanvas.addEventListener( "click", function(e) {
          notifyEventAudioPlayer(e);          
      });
      maincanvas.addEventListener( "mousemove", function(e) {
          notifyEventAudioPlayer(e);          
      });
      maincanvas.addEventListener( "mouseup", function(e) {
          notifyEventAudioPlayer(e);          
      });
      maincanvas.addEventListener( "mousedown", function(e) {
          notifyEventAudioPlayer(e);
      });
      var touchstart_cnt=0, touchend_cnt=0;
      maincanvas.addEventListener( "touchstart", function(e) {
          document.documentElement.style.overflow = 'hidden';
          touchstart_cnt++;
          if(touchstart_cnt>1 && touchend_cnt>1) e.preventDefault();
          notifyEventAudioPlayer(e);          
      });

      document.addEventListener('touchend', function(e) {
          document.documentElement.style.overflow = 'auto';
          touchend_cnt++;
          if(touchstart_cnt>1 && touchend_cnt>1) e.preventDefault();
          notifyEventAudioPlayer(e);                    
      }, false);
      document.addEventListener('touchmove', function(e) {
          e.preventDefault();
          notifyEventAudioPlayer(e);                              
      }, false);


	</script>
    
</body>
</html>
